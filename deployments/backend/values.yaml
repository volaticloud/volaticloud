# Helm values for AnyTrade Backend using Nixys Universal Chart
# Chart: nixys/nxs-universal-chart
# Repo: https://registry.nixys.io/chartrepo/public
# Docs: https://github.com/nixys/nxs-universal-chart

# Basic app configuration
replicaCount: 2

image:
  repository: ghcr.io/diazoxide/anytrade
  tag: latest  # Override via CI/CD
  pullPolicy: Always

# Service Account
serviceAccount:
  create: true
  name: anytrade-backend

# Deployment strategy
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

# Container configuration
containers:
  - name: anytrade
    image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
    imagePullPolicy: "{{ .Values.image.pullPolicy }}"

    ports:
      - name: http
        containerPort: 8080
        protocol: TCP

    # Environment variables
    env:
      - name: ANYTRADE_HOST
        value: "0.0.0.0"
      - name: ANYTRADE_PORT
        value: "8080"
      - name: ANYTRADE_MONITOR_INTERVAL
        value: "30s"

      # Database connection string from secret
      - name: ANYTRADE_DATABASE
        valueFrom:
          secretKeyRef:
            name: anytrade-secrets
            key: ANYTRADE_DATABASE

    # Health checks
    livenessProbe:
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 3
      failureThreshold: 3

    readinessProbe:
      httpGet:
        path: /health
        port: http
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 3

    # Resource limits
    resources:
      limits:
        cpu: 1000m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi

    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      readOnlyRootFilesystem: false
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL

# Pod security context
podSecurityContext:
  fsGroup: 1000
  runAsNonRoot: true
  runAsUser: 1000

# Service configuration
service:
  - name: http
    type: ClusterIP
    port: 8080
    targetPort: http
    protocol: TCP

# Ingress configuration
ingress:
  - name: main
    ingressClassName: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "true"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    hosts:
      - host: api.anytrade.com  # Update with your domain
        paths:
          - path: /
            pathType: Prefix
            serviceName: http
            servicePort: 8080
    tls:
      - secretName: anytrade-api-tls
        hosts:
          - api.anytrade.com

# Horizontal Pod Autoscaler
hpa:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

# Pod Disruption Budget
pdb:
  enabled: true
  minAvailable: 1

# Pod annotations
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "8080"
  prometheus.io/path: /metrics

# Pod labels
podLabels:
  app: anytrade-backend
  component: api

# Affinity rules (spread pods across nodes)
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - anytrade-backend
          topologyKey: kubernetes.io/hostname

# Tolerations (if needed for specific node pools)
tolerations: []

# Node selector (if needed)
nodeSelector: {}