package graph

import (
	"volaticloud/internal/ent"
	"volaticloud/internal/enum"
	"testing"

	"github.com/stretchr/testify/assert"
	"github.com/stretchr/testify/require"
)

func TestExchangeMutations(t *testing.T) {
	resolver := setupTestResolver(t)
	mutationResolver := resolver.Mutation()

	t.Run("CreateExchange", func(t *testing.T) {
		input := ent.CreateExchangeInput{
			Name:     enum.ExchangeBinance,
			TestMode: ptr(false),
		}

		exchange, err := mutationResolver.CreateExchange(ctx(), input)
		require.NoError(t, err)
		assert.NotNil(t, exchange)
		assert.Equal(t, enum.ExchangeBinance, exchange.Name)
		assert.False(t, exchange.TestMode)
	})

	t.Run("UpdateExchange", func(t *testing.T) {
		// Create exchange first
		input := ent.CreateExchangeInput{
			Name:     enum.ExchangeKraken,
			TestMode: ptr(true),
		}
		exchange, err := mutationResolver.CreateExchange(ctx(), input)
		require.NoError(t, err)

		// Update it
		newName := enum.ExchangeCoinbase
		updateInput := ent.UpdateExchangeInput{
			Name: &newName,
		}
		updated, err := mutationResolver.UpdateExchange(ctx(), exchange.ID, updateInput)
		require.NoError(t, err)
		assert.Equal(t, enum.ExchangeCoinbase, updated.Name)
		assert.Equal(t, exchange.ID, updated.ID)
	})

	t.Run("DeleteExchange", func(t *testing.T) {
		// Create exchange first
		input := ent.CreateExchangeInput{
			Name:     enum.ExchangeBybit,
			TestMode: ptr(false),
		}
		exchange, err := mutationResolver.CreateExchange(ctx(), input)
		require.NoError(t, err)

		// Delete it
		deleted, err := mutationResolver.DeleteExchange(ctx(), exchange.ID)
		require.NoError(t, err)
		assert.True(t, deleted)

		// Verify it's gone
		queryResolver := resolver.Query()
		result, err := queryResolver.Exchanges(ctx())
		require.NoError(t, err)

		found := false
		for _, e := range result {
			if e.ID == exchange.ID {
				found = true
				break
			}
		}
		assert.False(t, found, "Exchange should be deleted")
	})
}

func TestExchangeQueries(t *testing.T) {
	resolver := setupTestResolver(t)
	mutationResolver := resolver.Mutation()
	queryResolver := resolver.Query()

	// Create test data
	exchanges := []ent.CreateExchangeInput{
		{Name: enum.ExchangeBinance, TestMode: ptr(false)},
		{Name: enum.ExchangeKraken, TestMode: ptr(true)},
		{Name: enum.ExchangeCoinbase, TestMode: ptr(false)},
	}

	for _, input := range exchanges {
		_, err := mutationResolver.CreateExchange(ctx(), input)
		require.NoError(t, err)
	}

	t.Run("QueryExchanges", func(t *testing.T) {
		result, err := queryResolver.Exchanges(ctx())
		require.NoError(t, err)
		assert.GreaterOrEqual(t, len(result), 3)
	})
}
