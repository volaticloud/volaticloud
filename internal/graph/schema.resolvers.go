package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.81

import (
	"context"
	"fmt"

	"anytrade/internal/ent"
	"anytrade/internal/ent/bot"
	"anytrade/internal/enum"
	"anytrade/internal/runner"

	"github.com/google/uuid"
)

func (r *mutationResolver) CreateExchange(ctx context.Context, input ent.CreateExchangeInput) (*ent.Exchange, error) {
	return r.client.Exchange.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateExchange(ctx context.Context, id uuid.UUID, input ent.UpdateExchangeInput) (*ent.Exchange, error) {
	return r.client.Exchange.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteExchange(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.Exchange.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) CreateExchangeSecret(ctx context.Context, input ent.CreateExchangeSecretInput) (*ent.ExchangeSecret, error) {
	return r.client.ExchangeSecret.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateExchangeSecret(ctx context.Context, id uuid.UUID, input ent.UpdateExchangeSecretInput) (*ent.ExchangeSecret, error) {
	return r.client.ExchangeSecret.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteExchangeSecret(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.ExchangeSecret.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) CreateStrategy(ctx context.Context, input ent.CreateStrategyInput) (*ent.Strategy, error) {
	return r.client.Strategy.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateStrategy(ctx context.Context, id uuid.UUID, input ent.UpdateStrategyInput) (*ent.Strategy, error) {
	return r.client.Strategy.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteStrategy(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.Strategy.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) CreateBot(ctx context.Context, input ent.CreateBotInput) (*ent.Bot, error) {
	return r.client.Bot.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateBot(ctx context.Context, id uuid.UUID, input ent.UpdateBotInput) (*ent.Bot, error) {
	return r.client.Bot.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteBot(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.Bot.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) StartBot(ctx context.Context, id uuid.UUID) (*ent.Bot, error) {
	// Load the bot with its runtime configuration
	b, err := r.client.Bot.Query().
		Where(bot.ID(id)).
		WithRuntime().
		Only(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to load bot: %w", err)
	}

	// Get the runtime
	botRuntime := b.Edges.Runtime
	if botRuntime == nil {
		return nil, fmt.Errorf("bot has no runtime configuration")
	}

	// Create runtime client
	factory := runner.NewFactory()
	rt, err := factory.Create(ctx, botRuntime.Type, botRuntime.Config)
	if err != nil {
		return nil, fmt.Errorf("failed to create runtime client: %w", err)
	}
	defer rt.Close()

	// Start the bot in the runtime
	containerID := b.ContainerID
	if containerID == "" {
		return nil, fmt.Errorf("bot has no container ID - create the bot first")
	}

	if err := rt.StartBot(ctx, containerID); err != nil {
		return nil, fmt.Errorf("failed to start bot in runtime: %w", err)
	}

	// Update bot status
	b, err = r.client.Bot.UpdateOneID(id).
		SetStatus(enum.BotStatusRunning).
		Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to update bot status: %w", err)
	}

	return b, nil
}

func (r *mutationResolver) StopBot(ctx context.Context, id uuid.UUID) (*ent.Bot, error) {
	// Load the bot with its runtime configuration
	b, err := r.client.Bot.Query().
		Where(bot.ID(id)).
		WithRuntime().
		Only(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to load bot: %w", err)
	}

	// Get the runtime
	botRuntime := b.Edges.Runtime
	if botRuntime == nil {
		return nil, fmt.Errorf("bot has no runtime configuration")
	}

	// Create runtime client
	factory := runner.NewFactory()
	rt, err := factory.Create(ctx, botRuntime.Type, botRuntime.Config)
	if err != nil {
		return nil, fmt.Errorf("failed to create runtime client: %w", err)
	}
	defer rt.Close()

	// Stop the bot in the runtime
	containerID := b.ContainerID
	if containerID == "" {
		return nil, fmt.Errorf("bot has no container ID")
	}

	if err := rt.StopBot(ctx, containerID); err != nil {
		return nil, fmt.Errorf("failed to stop bot in runtime: %w", err)
	}

	// Update bot status
	b, err = r.client.Bot.UpdateOneID(id).
		SetStatus(enum.BotStatusStopped).
		Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to update bot status: %w", err)
	}

	return b, nil
}

func (r *mutationResolver) RestartBot(ctx context.Context, id uuid.UUID) (*ent.Bot, error) {
	// Load the bot with its runtime configuration
	b, err := r.client.Bot.Query().
		Where(bot.ID(id)).
		WithRuntime().
		Only(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to load bot: %w", err)
	}

	// Get the runtime
	botRuntime := b.Edges.Runtime
	if botRuntime == nil {
		return nil, fmt.Errorf("bot has no runtime configuration")
	}

	// Create runtime client
	factory := runner.NewFactory()
	rt, err := factory.Create(ctx, botRuntime.Type, botRuntime.Config)
	if err != nil {
		return nil, fmt.Errorf("failed to create runtime client: %w", err)
	}
	defer rt.Close()

	// Restart the bot in the runtime
	containerID := b.ContainerID
	if containerID == "" {
		return nil, fmt.Errorf("bot has no container ID")
	}

	if err := rt.RestartBot(ctx, containerID); err != nil {
		return nil, fmt.Errorf("failed to restart bot in runtime: %w", err)
	}

	// Update bot status
	b, err = r.client.Bot.UpdateOneID(id).
		SetStatus(enum.BotStatusRunning).
		Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to update bot status: %w", err)
	}

	return b, nil
}

func (r *mutationResolver) CreateBotRuntime(ctx context.Context, input ent.CreateBotRuntimeInput) (*ent.BotRuntime, error) {
	return r.client.BotRuntime.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateBotRuntime(ctx context.Context, id uuid.UUID, input ent.UpdateBotRuntimeInput) (*ent.BotRuntime, error) {
	return r.client.BotRuntime.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteBotRuntime(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.BotRuntime.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) CreateBacktest(ctx context.Context, input ent.CreateBacktestInput) (*ent.Backtest, error) {
	return r.client.Backtest.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateBacktest(ctx context.Context, id uuid.UUID, input ent.UpdateBacktestInput) (*ent.Backtest, error) {
	return r.client.Backtest.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteBacktest(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.Backtest.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) CreateTrade(ctx context.Context, input ent.CreateTradeInput) (*ent.Trade, error) {
	return r.client.Trade.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateTrade(ctx context.Context, id uuid.UUID, input ent.UpdateTradeInput) (*ent.Trade, error) {
	return r.client.Trade.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteTrade(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.Trade.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *queryResolver) GetBotRuntimeStatus(ctx context.Context, id uuid.UUID) (*runner.BotStatus, error) {
	// Load the bot with its runtime configuration
	b, err := r.client.Bot.Query().
		Where(bot.ID(id)).
		WithRuntime().
		Only(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to load bot: %w", err)
	}

	// Get the runtime
	botRuntime := b.Edges.Runtime
	if botRuntime == nil {
		return nil, fmt.Errorf("bot has no runtime configuration")
	}

	// Create runtime client
	factory := runner.NewFactory()
	rt, err := factory.Create(ctx, botRuntime.Type, botRuntime.Config)
	if err != nil {
		return nil, fmt.Errorf("failed to create runtime client: %w", err)
	}
	defer rt.Close()

	// Get bot status from runtime
	containerID := b.ContainerID
	if containerID == "" {
		return nil, fmt.Errorf("bot has no container ID")
	}

	status, err := rt.GetBotStatus(ctx, containerID)
	if err != nil {
		return nil, fmt.Errorf("failed to get bot status from runtime: %w", err)
	}

	return status, nil
}

func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

type mutationResolver struct{ *Resolver }
