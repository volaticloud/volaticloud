package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.81

import (
	"anytrade/internal/ent"
	"anytrade/internal/ent/bot"
	"anytrade/internal/enum"
	"anytrade/internal/runner"
	"context"
	"fmt"
	"strings"

	"github.com/google/uuid"
)

func (r *mutationResolver) CreateExchange(ctx context.Context, input ent.CreateExchangeInput) (*ent.Exchange, error) {
	return r.client.Exchange.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateExchange(ctx context.Context, id uuid.UUID, input ent.UpdateExchangeInput) (*ent.Exchange, error) {
	return r.client.Exchange.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteExchange(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.Exchange.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) CreateStrategy(ctx context.Context, input ent.CreateStrategyInput) (*ent.Strategy, error) {
	return r.client.Strategy.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateStrategy(ctx context.Context, id uuid.UUID, input ent.UpdateStrategyInput) (*ent.Strategy, error) {
	return r.client.Strategy.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteStrategy(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.Strategy.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) CreateBot(ctx context.Context, input ent.CreateBotInput) (*ent.Bot, error) {
	// Step 1: Validate bot config has required Freqtrade fields
	if input.Config != nil {
		if err := validateFreqtradeConfig(input.Config); err != nil {
			return nil, fmt.Errorf("invalid bot configuration: %w", err)
		}
	} else {
		return nil, fmt.Errorf("bot config is required for Freqtrade bots")
	}

	// Step 2: Create the bot in the database
	createdBot, err := r.client.Bot.Create().SetInput(input).Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to create bot: %w", err)
	}

	// Step 2: Load the bot with all its relations
	createdBot, err = r.client.Bot.Query().
		Where(bot.IDEQ(createdBot.ID)).
		WithRunner().
		WithExchange().
		WithStrategy().
		Only(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to load bot with relations: %w", err)
	}

	// Step 3: Create the runner client
	botRunner := createdBot.Edges.Runner
	if botRunner == nil {
		return nil, fmt.Errorf("bot has no runner configuration")
	}

	factory := runner.NewFactory()
	rt, err := factory.Create(ctx, botRunner.Type, botRunner.Config)
	if err != nil {
		return nil, fmt.Errorf("failed to create runner client: %w", err)
	}
	defer rt.Close()

	// Step 4: Build BotSpec from bot data
	spec, err := buildBotSpec(createdBot)
	if err != nil {
		return nil, fmt.Errorf("failed to build bot spec: %w", err)
	}

	// Step 5: Create the container
	containerID, err := rt.CreateBot(ctx, *spec)
	if err != nil {
		// Update bot status to error
		r.client.Bot.UpdateOneID(createdBot.ID).
			SetStatus(enum.BotStatusError).
			SetErrorMessage(fmt.Sprintf("Failed to create container: %v", err)).
			Save(ctx)
		return nil, fmt.Errorf("failed to create bot container: %w", err)
	}

	// Step 6: Update bot with container_id and set status to stopped
	createdBot, err = r.client.Bot.UpdateOneID(createdBot.ID).
		SetContainerID(containerID).
		SetStatus(enum.BotStatusStopped).
		ClearErrorMessage().
		Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to update bot with container ID: %w", err)
	}

	return createdBot, nil
}

func (r *mutationResolver) UpdateBot(ctx context.Context, id uuid.UUID, input ent.UpdateBotInput) (*ent.Bot, error) {
	// Validate bot config if it's being updated
	if input.Config != nil {
		if err := validateFreqtradeConfig(input.Config); err != nil {
			return nil, fmt.Errorf("invalid bot configuration: %w", err)
		}
	}

	return r.client.Bot.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteBot(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.Bot.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) StartBot(ctx context.Context, id uuid.UUID) (*ent.Bot, error) {
	// Load the bot with its runner, exchange, and strategy
	b, err := r.client.Bot.Query().
		Where(bot.ID(id)).
		WithRunner().
		WithExchange().
		WithStrategy().
		Only(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to load bot: %w", err)
	}

	// Get the runner
	botRunner := b.Edges.Runner
	if botRunner == nil {
		return nil, fmt.Errorf("bot has no runner configuration")
	}

	// Create runner client
	factory := runner.NewFactory()
	rt, err := factory.Create(ctx, botRunner.Type, botRunner.Config)
	if err != nil {
		return nil, fmt.Errorf("failed to create runner client: %w", err)
	}
	defer rt.Close()

	// Check if container exists, if not create it
	containerID := b.ContainerID
	if containerID == "" {
		// Build BotSpec from bot data
		spec, err := buildBotSpec(b)
		if err != nil {
			return nil, fmt.Errorf("failed to build bot spec: %w", err)
		}

		// Create the container
		containerID, err = rt.CreateBot(ctx, *spec)
		if err != nil {
			// Update bot status to error
			r.client.Bot.UpdateOneID(b.ID).
				SetStatus(enum.BotStatusError).
				SetErrorMessage(fmt.Sprintf("Failed to create container: %v", err)).
				Save(ctx)
			return nil, fmt.Errorf("failed to create bot container: %w", err)
		}

		// Update bot with container_id
		b, err = r.client.Bot.UpdateOneID(b.ID).
			SetContainerID(containerID).
			ClearErrorMessage().
			Save(ctx)
		if err != nil {
			return nil, fmt.Errorf("failed to update bot with container ID: %w", err)
		}
	}

	// Start the bot in the runtime
	if err := rt.StartBot(ctx, containerID); err != nil {
		// If container not found, clear container ID and return error
		if strings.Contains(err.Error(), "not found") || strings.Contains(err.Error(), "No such container") {
			r.client.Bot.UpdateOneID(id).
				ClearContainerID().
				SetStatus(enum.BotStatusStopped).
				Save(ctx)
			return nil, fmt.Errorf("container was deleted manually - please try starting again")
		}
		return nil, fmt.Errorf("failed to start bot in runner: %w", err)
	}

	// Update bot status
	b, err = r.client.Bot.UpdateOneID(id).
		SetStatus(enum.BotStatusRunning).
		Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to update bot status: %w", err)
	}

	return b, nil
}

func (r *mutationResolver) StopBot(ctx context.Context, id uuid.UUID) (*ent.Bot, error) {
	// Load the bot with its runner configuration
	b, err := r.client.Bot.Query().
		Where(bot.ID(id)).
		WithRunner().
		Only(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to load bot: %w", err)
	}

	// Get the runner
	botRunner := b.Edges.Runner
	if botRunner == nil {
		return nil, fmt.Errorf("bot has no runner configuration")
	}

	// Create runner client
	factory := runner.NewFactory()
	rt, err := factory.Create(ctx, botRunner.Type, botRunner.Config)
	if err != nil {
		return nil, fmt.Errorf("failed to create runner client: %w", err)
	}
	defer rt.Close()

	// Stop the bot in the runtime
	containerID := b.ContainerID
	if containerID == "" {
		// No container ID means it was never created or already deleted
		// Just update status to stopped
		b, err = r.client.Bot.UpdateOneID(id).
			SetStatus(enum.BotStatusStopped).
			Save(ctx)
		if err != nil {
			return nil, fmt.Errorf("failed to update bot status: %w", err)
		}
		return b, nil
	}

	if err := rt.StopBot(ctx, containerID); err != nil {
		// If container not found, just update status - it was manually deleted
		if strings.Contains(err.Error(), "not found") || strings.Contains(err.Error(), "No such container") {
			b, err = r.client.Bot.UpdateOneID(id).
				SetStatus(enum.BotStatusStopped).
				ClearContainerID().
				Save(ctx)
			if err != nil {
				return nil, fmt.Errorf("failed to update bot status: %w", err)
			}
			return b, nil
		}
		return nil, fmt.Errorf("failed to stop bot in runner: %w", err)
	}

	// Update bot status
	b, err = r.client.Bot.UpdateOneID(id).
		SetStatus(enum.BotStatusStopped).
		Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to update bot status: %w", err)
	}

	return b, nil
}

func (r *mutationResolver) RestartBot(ctx context.Context, id uuid.UUID) (*ent.Bot, error) {
	// Load the bot with its runner, exchange, and strategy
	b, err := r.client.Bot.Query().
		Where(bot.ID(id)).
		WithRunner().
		WithExchange().
		WithStrategy().
		Only(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to load bot: %w", err)
	}

	// Get the runner
	botRunner := b.Edges.Runner
	if botRunner == nil {
		return nil, fmt.Errorf("bot has no runner configuration")
	}

	// Create runner client
	factory := runner.NewFactory()
	rt, err := factory.Create(ctx, botRunner.Type, botRunner.Config)
	if err != nil {
		return nil, fmt.Errorf("failed to create runner client: %w", err)
	}
	defer rt.Close()

	// Check if container exists, if not create it
	containerID := b.ContainerID
	if containerID == "" {
		// Build BotSpec from bot data
		spec, err := buildBotSpec(b)
		if err != nil {
			return nil, fmt.Errorf("failed to build bot spec: %w", err)
		}

		// Create the container
		containerID, err = rt.CreateBot(ctx, *spec)
		if err != nil {
			// Update bot status to error
			r.client.Bot.UpdateOneID(b.ID).
				SetStatus(enum.BotStatusError).
				SetErrorMessage(fmt.Sprintf("Failed to create container: %v", err)).
				Save(ctx)
			return nil, fmt.Errorf("failed to create bot container: %w", err)
		}

		// Update bot with container_id
		b, err = r.client.Bot.UpdateOneID(b.ID).
			SetContainerID(containerID).
			ClearErrorMessage().
			Save(ctx)
		if err != nil {
			return nil, fmt.Errorf("failed to update bot with container ID: %w", err)
		}
	}

	// Restart the bot in the runtime
	if err := rt.RestartBot(ctx, containerID); err != nil {
		// If container not found, clear container ID and return error
		if strings.Contains(err.Error(), "not found") || strings.Contains(err.Error(), "No such container") {
			r.client.Bot.UpdateOneID(id).
				ClearContainerID().
				SetStatus(enum.BotStatusStopped).
				Save(ctx)
			return nil, fmt.Errorf("container was deleted manually - please try restarting again")
		}
		return nil, fmt.Errorf("failed to restart bot in runner: %w", err)
	}

	// Update bot status
	b, err = r.client.Bot.UpdateOneID(id).
		SetStatus(enum.BotStatusRunning).
		Save(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to update bot status: %w", err)
	}

	return b, nil
}

func (r *mutationResolver) CreateBotRunner(ctx context.Context, input ent.CreateBotRunnerInput) (*ent.BotRunner, error) {
	return r.client.BotRunner.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateBotRunner(ctx context.Context, id uuid.UUID, input ent.UpdateBotRunnerInput) (*ent.BotRunner, error) {
	return r.client.BotRunner.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteBotRunner(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.BotRunner.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) CreateBacktest(ctx context.Context, input ent.CreateBacktestInput) (*ent.Backtest, error) {
	return r.client.Backtest.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateBacktest(ctx context.Context, id uuid.UUID, input ent.UpdateBacktestInput) (*ent.Backtest, error) {
	return r.client.Backtest.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteBacktest(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.Backtest.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *mutationResolver) CreateTrade(ctx context.Context, input ent.CreateTradeInput) (*ent.Trade, error) {
	return r.client.Trade.Create().SetInput(input).Save(ctx)
}

func (r *mutationResolver) UpdateTrade(ctx context.Context, id uuid.UUID, input ent.UpdateTradeInput) (*ent.Trade, error) {
	return r.client.Trade.UpdateOneID(id).SetInput(input).Save(ctx)
}

func (r *mutationResolver) DeleteTrade(ctx context.Context, id uuid.UUID) (bool, error) {
	err := r.client.Trade.DeleteOneID(id).Exec(ctx)
	return err == nil, err
}

func (r *queryResolver) GetBotRunnerStatus(ctx context.Context, id uuid.UUID) (*runner.BotStatus, error) {
	// Load the bot with its runner configuration
	b, err := r.client.Bot.Query().
		Where(bot.ID(id)).
		WithRunner().
		Only(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to load bot: %w", err)
	}

	// Get the runner
	botRunner := b.Edges.Runner
	if botRunner == nil {
		return nil, fmt.Errorf("bot has no runner configuration")
	}

	// Create runner client
	factory := runner.NewFactory()
	rt, err := factory.Create(ctx, botRunner.Type, botRunner.Config)
	if err != nil {
		return nil, fmt.Errorf("failed to create runner client: %w", err)
	}
	defer rt.Close()

	// Get bot status from runner
	containerID := b.ContainerID
	if containerID == "" {
		return nil, fmt.Errorf("bot has no container ID")
	}

	status, err := rt.GetBotStatus(ctx, containerID)
	if err != nil {
		return nil, fmt.Errorf("failed to get bot status from runner: %w", err)
	}

	return status, nil
}

func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

type mutationResolver struct{ *Resolver }
