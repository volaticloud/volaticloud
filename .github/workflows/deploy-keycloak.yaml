name: Deploy Keycloak

on:
  push:
    branches: [main, feature/keycloak-openid-integration]
    paths:
      - 'deployments/olm/**'
      - 'deployments/keycloak/**'
      - '.github/workflows/deploy-keycloak.yaml'
  pull_request:
    paths:
      - 'deployments/olm/**'
      - 'deployments/keycloak/**'
      - '.github/workflows/deploy-keycloak.yaml'
  workflow_dispatch:
    inputs:
      skip-olm:
        description: 'Skip OLM installation (if already installed)'
        required: false
        type: boolean
        default: true

env:
  KUBECONFIG_PATH: ./kubeconfig

jobs:
  validate:
    name: Validate Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Validate Keycloak manifests
        run: |
          echo "üîç Validating Kubernetes manifests..."
          kubectl apply --dry-run=client -f deployments/keycloak/namespace.yaml
          kubectl apply --dry-run=client -f deployments/keycloak/operator-subscription.yaml
          kubectl apply --dry-run=client -f deployments/keycloak/keycloak-instance.yaml
          kubectl apply --dry-run=client -f deployments/keycloak/keycloak-realm.yaml
          kubectl apply --dry-run=client -f deployments/keycloak/keycloak-client.yaml
          echo "‚úÖ All manifests are valid"

      - name: Check for hardcoded secrets
        run: |
          echo "üîç Checking for hardcoded secrets..."
          if grep -r "password:" deployments/keycloak/ | grep -v "passwordSecret" | grep -v "#"; then
            echo "‚ùå Found hardcoded password in manifest"
            exit 1
          fi
          echo "‚úÖ No hardcoded secrets found"

  install-olm:
    name: Install OLM
    runs-on: ubuntu-latest
    needs: validate
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && !inputs.skip-olm) ||
      github.ref == 'refs/heads/feature/keycloak-openid-integration'
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > $KUBECONFIG_PATH
          export KUBECONFIG=$KUBECONFIG_PATH
          kubectl cluster-info
          echo "‚úÖ Connected to Kubernetes cluster"

      - name: Check if OLM is already installed
        id: check-olm
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          if kubectl get namespace olm &>/dev/null && kubectl get csv -n olm &>/dev/null; then
            echo "olm-installed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ OLM is already installed"
          else
            echo "olm-installed=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  OLM is not installed"
          fi

      - name: Install OLM
        if: steps.check-olm.outputs.olm-installed == 'false'
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          cd deployments/olm
          chmod +x install.sh
          ./install.sh

      - name: Verify OLM installation
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          echo "üìã OLM Pods:"
          kubectl get pods -n olm
          echo ""
          echo "üìã Catalog Sources:"
          kubectl get catalogsource -n olm
          echo "‚úÖ OLM is ready"

  deploy-keycloak:
    name: Deploy Keycloak
    runs-on: ubuntu-latest
    needs: [validate, install-olm]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (needs.install-olm.result == 'success' || needs.install-olm.result == 'skipped') &&
      ((github.event_name == 'push' && github.ref == 'refs/heads/main') ||
       github.event_name == 'workflow_dispatch' ||
       github.ref == 'refs/heads/feature/keycloak-openid-integration')
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > $KUBECONFIG_PATH
          export KUBECONFIG=$KUBECONFIG_PATH
          kubectl cluster-info

      - name: Create Keycloak namespace
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          echo "üì¶ Creating Keycloak namespace..."
          kubectl apply -f deployments/keycloak/namespace.yaml
          echo "‚úÖ Namespace created"

      - name: Create database secret
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          echo "üîê Creating database secret..."

          # Create secret from GitHub Secrets
          kubectl create secret generic keycloak-db-secret \
            --from-literal=username="${{ secrets.KEYCLOAK_DB_USERNAME }}" \
            --from-literal=password="${{ secrets.KEYCLOAK_DB_PASSWORD }}" \
            --namespace=keycloak \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "‚úÖ Database secret created"

      - name: Install Keycloak operator
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          echo "üì¶ Installing Keycloak operator..."
          kubectl apply -f deployments/keycloak/operator-subscription.yaml

          echo "‚è≥ Waiting for operator to be ready..."
          # Wait for operator to be installed (check for CSV)
          for i in {1..60}; do
            if kubectl get csv -n keycloak 2>/dev/null | grep -q keycloak; then
              echo "‚úÖ Keycloak operator is installing..."
              break
            fi
            echo "Waiting for operator... ($i/60)"
            sleep 5
          done

          # Wait for operator pod to be ready
          kubectl wait --for=condition=Ready pod \
            -l control-plane=controller-manager \
            -n keycloak \
            --timeout=300s || echo "Warning: Operator pod not ready yet, continuing..."

          echo "‚úÖ Keycloak operator installed"

      - name: Process and apply Keycloak instance
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          echo "üöÄ Deploying Keycloak instance..."

          # Substitute environment variables in manifest
          envsubst < deployments/keycloak/keycloak-instance.yaml | \
          KEYCLOAK_DB_HOST="${{ secrets.KEYCLOAK_DB_HOST }}" \
          KEYCLOAK_HOSTNAME="${{ secrets.KEYCLOAK_HOSTNAME }}" \
          envsubst > /tmp/keycloak-instance-processed.yaml

          cat /tmp/keycloak-instance-processed.yaml
          kubectl apply -f /tmp/keycloak-instance-processed.yaml

          echo "‚è≥ Waiting for Keycloak to be ready..."
          kubectl wait --for=condition=Ready \
            keycloak/anytrade-keycloak \
            -n keycloak \
            --timeout=600s || echo "Warning: Keycloak not ready yet, check status manually"

          echo "‚úÖ Keycloak instance deployed"

      - name: Apply realm configuration
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          echo "üîß Configuring Keycloak realm..."
          kubectl apply -f deployments/keycloak/keycloak-realm.yaml

          echo "‚è≥ Waiting for realm to be imported..."
          sleep 30

          echo "‚úÖ Realm configured"

      - name: Apply OIDC client configuration
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          echo "üîß Configuring OIDC clients..."

          # Substitute environment variables in client manifest
          envsubst < deployments/keycloak/keycloak-client.yaml | \
          ANYTRADE_URL="${{ secrets.ANYTRADE_URL }}" \
          envsubst > /tmp/keycloak-client-processed.yaml

          kubectl apply -f /tmp/keycloak-client-processed.yaml

          echo "‚è≥ Waiting for clients to be imported..."
          sleep 30

          echo "‚úÖ OIDC clients configured"

      - name: Get Keycloak status
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          echo "üìä Keycloak Status:"
          echo ""
          echo "Keycloak Instances:"
          kubectl get keycloak -n keycloak
          echo ""
          echo "Pods:"
          kubectl get pods -n keycloak
          echo ""
          echo "Services:"
          kubectl get svc -n keycloak
          echo ""
          echo "Ingress:"
          kubectl get ingress -n keycloak || echo "No ingress found"

      - name: Verify Keycloak endpoints
        run: |
          export KUBECONFIG=$KUBECONFIG_PATH
          echo "üîç Verifying Keycloak endpoints..."

          # Get Keycloak URL from status or service
          KEYCLOAK_SERVICE=$(kubectl get svc -n keycloak -l app=keycloak -o jsonpath='{.items[0].metadata.name}')

          if [ -n "$KEYCLOAK_SERVICE" ]; then
            echo "‚úÖ Keycloak service found: $KEYCLOAK_SERVICE"
            echo "üåê Access Keycloak at: https://${{ secrets.KEYCLOAK_HOSTNAME }}/auth"
          else
            echo "‚ö†Ô∏è  Keycloak service not found yet"
          fi

      - name: Create deployment record
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'prod',
              description: 'Keycloak deployed successfully',
              auto_merge: false,
              required_contexts: []
            });

      - name: Deployment summary
        if: success()
        run: |
          echo "## ‚úÖ Keycloak Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Realm**: anytrade" >> $GITHUB_STEP_SUMMARY
          echo "- **Clients**: anytrade-dashboard, anytrade-api" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://${{ secrets.KEYCLOAK_HOSTNAME }}/auth" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîê Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Access Keycloak admin console" >> $GITHUB_STEP_SUMMARY
          echo "2. Create users and assign roles" >> $GITHUB_STEP_SUMMARY
          echo "3. Test OIDC authentication flow" >> $GITHUB_STEP_SUMMARY
