name: Deploy etcd Cluster to VKE

on:
  push:
    branches: [main]
    paths:
      - 'deployments/etcd/**'
      - '.github/workflows/deploy-etcd.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - upgrade
          - delete

concurrency:
  group: deploy-etcd-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel etcd deployments

jobs:
  deploy:
    name: Deploy etcd Cluster
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment:
      name: prod
      url: https://etcd.anytrade.internal

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify cluster access
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Install cert-manager (prerequisite for etcd-operator)
        run: |
          # Check if cert-manager is already installed
          if ! kubectl get deployment -n cert-manager cert-manager-webhook 2>/dev/null; then
            echo "Installing cert-manager..."
            kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.2/cert-manager.yaml

            echo "Waiting for cert-manager to be ready..."
            kubectl wait --for=condition=available --timeout=300s \
              deployment/cert-manager-webhook -n cert-manager
          else
            echo "cert-manager already installed"
          fi

      - name: Install etcd-operator
        run: |
          echo "Installing etcd-operator..."
          kubectl apply -f https://github.com/aenix-io/etcd-operator/releases/download/v0.4.2/etcd-operator.yaml

          echo "Waiting for etcd-operator to be ready..."
          kubectl wait --for=condition=available --timeout=300s \
            deployment/etcd-operator-controller-manager -n etcd-operator-system

      - name: Create etcd-system namespace
        run: |
          kubectl create namespace etcd-system --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy etcd cluster via operator
        run: |
          echo "Applying EtcdCluster CRD..."
          kubectl apply -f deployments/etcd/etcdcluster.yaml

          echo "Waiting for etcd cluster to be ready..."
          kubectl wait --for=condition=ready --timeout=600s \
            pod -l app.kubernetes.io/name=anytrade-etcd -n etcd-system || true

      - name: Verify deployment
        run: |
          echo "Checking EtcdCluster resource status..."
          kubectl get etcdcluster -n etcd-system anytrade-etcd -o yaml

          echo "Checking StatefulSet status..."
          kubectl get statefulset -n etcd-system

          echo "Checking pod status..."
          kubectl get pods -n etcd-system

          echo "Getting service info..."
          kubectl get svc -n etcd-system

          echo "Checking PVCs..."
          kubectl get pvc -n etcd-system

          echo "Waiting for all etcd pods to be ready..."
          kubectl wait --for=condition=ready --timeout=600s \
            pod -l app.kubernetes.io/managed-by=etcd-operator -n etcd-system || \
          kubectl wait --for=condition=ready --timeout=600s \
            pod -l app.kubernetes.io/name=anytrade-etcd -n etcd-system

      - name: Test etcd cluster health
        run: |
          # Wait a bit for cluster to stabilize
          sleep 10

          # Get first etcd pod name (try different label selectors)
          ETCD_POD=$(kubectl get pods -n etcd-system -o jsonpath='{.items[0].metadata.name}')

          echo "Testing etcd cluster health via pod: $ETCD_POD"

          # Get StatefulSet name to determine endpoint pattern
          STATEFULSET=$(kubectl get statefulset -n etcd-system -o jsonpath='{.items[0].metadata.name}')

          echo "StatefulSet name: $STATEFULSET"

          # Check endpoint health (using StatefulSet-based endpoints)
          kubectl exec -n etcd-system $ETCD_POD -- etcdctl endpoint health \
            --cluster=true \
            --endpoints=${STATEFULSET}-0.${STATEFULSET}-headless.etcd-system.svc.cluster.local:2379,${STATEFULSET}-1.${STATEFULSET}-headless.etcd-system.svc.cluster.local:2379,${STATEFULSET}-2.${STATEFULSET}-headless.etcd-system.svc.cluster.local:2379 || \
          kubectl exec -n etcd-system $ETCD_POD -- etcdctl endpoint health --cluster=true

          # Check member list
          kubectl exec -n etcd-system $ETCD_POD -- etcdctl member list -w table

      - name: Generate deployment summary
        run: |
          echo "### etcd Cluster Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** prod" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** etcd-system" >> $GITHUB_STEP_SUMMARY
          echo "**Replicas:** 3" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Method:** etcd-operator (aenix.io)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**EtcdCluster Resource:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get etcdcluster -n etcd-system >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Resources:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get all -n etcd-system >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Persistent Volumes:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pvc -n etcd-system >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "### etcd Deployment Failed! âŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Check the logs above for details**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recent Events:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get events -n etcd-system --sort-by='.lastTimestamp' | tail -20 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: Cleanup on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure() && github.ref == 'refs/heads/main'
    environment: prod

    steps:
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Delete failed EtcdCluster resource
        run: |
          echo "Deleting failed EtcdCluster resource..."
          kubectl delete etcdcluster anytrade-etcd -n etcd-system --ignore-not-found=true

          echo "Waiting for resources to be cleaned up by operator..."
          kubectl wait --for=delete pod -l app.kubernetes.io/name=anytrade-etcd -n etcd-system --timeout=300s || true

      - name: Cleanup summary
        run: |
          echo "### Cleanup Completed âš ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The failed etcd cluster has been cleaned up." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** With GitOps, rollback is done by reverting the git commit and reapplying." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Remaining Resources:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get all -n etcd-system >> $GITHUB_STEP_SUMMARY || echo "No resources remaining" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY