name: Deploy etcd Cluster to VKE

on:
  push:
    branches: [main]
    paths:
      - 'deployments/etcd/**'
      - '.github/workflows/deploy-etcd.yml'
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment action'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - upgrade
          - rollback

concurrency:
  group: deploy-etcd-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel etcd deployments

jobs:
  validate:
    name: Validate etcd Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Add Bitnami Helm repository
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Validate Helm values
        run: |
          helm template etcd bitnami/etcd \
            -f deployments/etcd/values.yaml \
            --namespace etcd-system \
            --dry-run --debug

  deploy:
    name: Deploy etcd Cluster
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    environment:
      name: prod-etcd
      url: https://etcd.anytrade.internal

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify cluster access
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Add Bitnami Helm repository
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Create etcd-system namespace
        run: |
          kubectl create namespace etcd-system --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy or upgrade etcd cluster
        run: |
          helm upgrade --install etcd bitnami/etcd \
            --namespace etcd-system \
            --create-namespace \
            -f deployments/etcd/values.yaml \
            --wait \
            --timeout 10m \
            --atomic

      - name: Verify deployment
        run: |
          echo "Waiting for etcd StatefulSet to be ready..."
          kubectl wait --for=condition=ready --timeout=600s \
            pod -l app.kubernetes.io/name=etcd -n etcd-system

          echo "Checking StatefulSet status..."
          kubectl get statefulset -n etcd-system -l app.kubernetes.io/name=etcd

          echo "Checking pod status..."
          kubectl get pods -n etcd-system -l app.kubernetes.io/name=etcd

          echo "Getting service info..."
          kubectl get svc -n etcd-system -l app.kubernetes.io/name=etcd

          echo "Checking PVCs..."
          kubectl get pvc -n etcd-system

      - name: Test etcd cluster health
        run: |
          # Wait a bit for cluster to stabilize
          sleep 10

          # Get etcd pod name
          ETCD_POD=$(kubectl get pods -n etcd-system -l app.kubernetes.io/name=etcd -o jsonpath='{.items[0].metadata.name}')

          echo "Testing etcd cluster health via pod: $ETCD_POD"

          # Check endpoint health
          kubectl exec -n etcd-system $ETCD_POD -- etcdctl endpoint health \
            --cluster=true \
            --endpoints=etcd-0.etcd-headless.etcd-system.svc.cluster.local:2379,etcd-1.etcd-headless.etcd-system.svc.cluster.local:2379,etcd-2.etcd-headless.etcd-system.svc.cluster.local:2379

          # Check member list
          kubectl exec -n etcd-system $ETCD_POD -- etcdctl member list -w table

      - name: Generate deployment summary
        run: |
          echo "### etcd Cluster Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** prod" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** etcd-system" >> $GITHUB_STEP_SUMMARY
          echo "**Replicas:** 3" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster Resources:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get all -n etcd-system -l app.kubernetes.io/name=etcd >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Persistent Volumes:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pvc -n etcd-system >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "### etcd Deployment Failed! âŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Check the logs above for details**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recent Events:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get events -n etcd-system --sort-by='.lastTimestamp' | tail -20 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure() && github.ref == 'refs/heads/main'
    environment: prod-etcd

    steps:
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Rollback Helm release
        run: |
          echo "Rolling back etcd cluster to previous version..."
          helm rollback etcd -n etcd-system

          echo "Waiting for rollback to complete..."
          kubectl wait --for=condition=ready --timeout=600s \
            pod -l app.kubernetes.io/name=etcd -n etcd-system

      - name: Verify rollback
        run: |
          echo "### Rollback Completed âš ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The etcd cluster has been rolled back to the previous version." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current Status:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          helm history etcd -n etcd-system >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY