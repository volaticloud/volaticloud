name: Deploy Backend to VKE

on:
  # Wait for build to complete before deploying
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
    branches: [main]
  # Allow manual deployments (for manifest-only changes or rollbacks)
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
          - staging
      image_tag:
        description: 'Docker image tag to deploy (leave empty for latest)'
        required: false
        type: string

concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: false  # Don't cancel deployments

jobs:
  validate:
    name: Validate Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Add Nixys Helm repository
        run: |
          helm repo add nixys https://registry.nixys.io/chartrepo/public
          helm repo update

      - name: Validate Helm values
        run: |
          helm template volaticloud-backend nixys/nxs-universal-chart \
            -f deployments/backend/values.yaml \
            --dry-run --debug

  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main'
    environment:
      name: prod
      url: https://api.volaticloud.com

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify cluster access
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Add Nixys Helm repository
        run: |
          helm repo add nixys https://registry.nixys.io/chartrepo/public
          helm repo update

      - name: Determine image tag
        id: image_tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            # Use short commit SHA to match the build workflow
            echo "tag=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          fi

      - name: Create namespace if not exists
        run: |
          kubectl create namespace volaticloud --dry-run=client -o yaml | kubectl apply -f -

      - name: Create application secrets
        run: |
          kubectl create secret generic volaticloud-backend-volaticloud-secrets \
            --from-literal=ANYTRADE_DATABASE="${{ secrets.ANYTRADE_DATABASE }}" \
            --namespace=volaticloud \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create image pull secret
        run: |
          kubectl create secret docker-registry ghcr-pull-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GHCR_TOKEN }} \
            --namespace=volaticloud \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy backend with Helm
        run: |
          helm upgrade --install volaticloud-backend nixys/nxs-universal-chart \
            --namespace volaticloud \
            --create-namespace \
            -f deployments/backend/values.yaml \
            --set deployments.volaticloud-backend.containers[0].image=ghcr.io/diazoxide/volaticloud \
            --set deployments.volaticloud-backend.containers[0].imageTag=${{ steps.image_tag.outputs.tag }} \
            --set deployments.volaticloud-backend.imagePullSecrets[0].name=ghcr-pull-secret \
            --wait \
            --timeout 10m \
            --atomic

      - name: Verify deployment
        run: |
          echo "Waiting for deployment to be ready..."
          kubectl wait --for=condition=available --timeout=300s \
            deployment/volaticloud-backend-volaticloud-backend -n volaticloud

          echo "Checking pod status..."
          kubectl get pods -n volaticloud -l app=volaticloud-backend

          echo "Getting service info..."
          kubectl get svc -n volaticloud -l app=volaticloud-backend

          echo "Getting ingress info..."
          kubectl get ingress -n volaticloud

      - name: Run post-deployment tests
        run: |
          # Wait for service to be fully ready
          sleep 30

          # Get the service endpoint
          BACKEND_URL="https://api.volaticloud.com"

          echo "Testing health endpoint..."
          curl -f -s -o /dev/null -w "HTTP Status: %{http_code}\n" ${BACKEND_URL}/health || true

      - name: Generate deployment summary
        run: |
          echo "### Backend Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** prod" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ steps.image_tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** volaticloud" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://api.volaticloud.com" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Resources:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get all -n volaticloud -l app=volaticloud-backend >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "### Deployment Failed! âŒ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Check the logs above for details**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Recent Pod Events:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get events -n volaticloud --sort-by='.lastTimestamp' | tail -20 >> $GITHUB_STEP_SUMMARY || true
          echo '```' >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure() && github.ref == 'refs/heads/main'
    environment: prod

    steps:
      - name: Configure kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Rollback Helm release
        run: |
          echo "Rolling back to previous version..."
          helm rollback volaticloud-backend -n volaticloud

          echo "Waiting for rollback to complete..."
          kubectl wait --for=condition=available --timeout=300s \
            deployment/volaticloud-backend-volaticloud-backend -n volaticloud

      - name: Verify rollback
        run: |
          echo "### Rollback Completed âš ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment has been rolled back to the previous version." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Current Status:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          helm history volaticloud-backend -n volaticloud >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
