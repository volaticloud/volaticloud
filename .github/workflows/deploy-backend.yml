name: Deploy Backend to VKE

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types: [completed]
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag (leave empty for latest commit)'
        required: false
        type: string

concurrency:
  group: deploy-backend-${{ github.ref }}
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy
    runs-on: ${{ vars.RUNNER_LABEL }}
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    environment:
      name: prod
      url: https://api.volaticloud.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl and Helm
        uses: ./.github/actions/setup-kubectl-helm
        with:
          kubeconfig: ${{ secrets.VKE_KUBECONFIG }}

      - name: Add Helm repos
        run: |
          helm repo add nixys https://registry.nixys.io/chartrepo/public
          helm repo update

      - name: Determine image tag
        id: tag
        run: |
          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            TAG="${{ github.event.inputs.image_tag }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Use the SHA from the triggering workflow (first 7 chars)
            FULL_SHA="${{ github.event.workflow_run.head_sha }}"
            TAG="${FULL_SHA:0:7}"
          else
            TAG="${GITHUB_SHA::7}"
          fi
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Using image tag: ${TAG}"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify image exists
        run: |
          echo "Checking if image exists: ghcr.io/${{ github.repository_owner }}/volaticloud:${{ steps.tag.outputs.tag }}"
          docker pull ghcr.io/${{ github.repository_owner }}/volaticloud:${{ steps.tag.outputs.tag }} || \
            (echo "::error::Image not found. Please ensure Docker build completed successfully." && exit 1)

      - name: Create namespace
        run: |
          kubectl create namespace volaticloud \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create application secrets
        run: |
          kubectl create secret generic volaticloud-backend-volaticloud-secrets \
            --from-literal=VOLATICLOUD_DATABASE="${{ secrets.VOLATICLOUD_DATABASE }}" \
            --from-literal=VOLATICLOUD_KEYCLOAK_URL="${{ secrets.VOLATICLOUD_KEYCLOAK_URL }}" \
            --from-literal=VOLATICLOUD_KEYCLOAK_REALM="${{ secrets.VOLATICLOUD_KEYCLOAK_REALM }}" \
            --from-literal=VOLATICLOUD_KEYCLOAK_CLIENT_ID="${{ secrets.VOLATICLOUD_KEYCLOAK_CLIENT_ID }}" \
            --from-literal=VOLATICLOUD_KEYCLOAK_CLIENT_SECRET="${{ secrets.VOLATICLOUD_KEYCLOAK_CLIENT_SECRET }}" \
            --namespace=volaticloud \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Create image pull secret
        run: |
          kubectl create secret docker-registry ghcr-pull-secret \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GHCR_TOKEN }} \
            --namespace=volaticloud \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy
        run: |
          helm upgrade --install volaticloud-backend nixys/nxs-universal-chart \
            --namespace volaticloud \
            -f deployments/backend/values.yaml \
            --set deployments.volaticloud-backend.containers[0].image=ghcr.io/volaticloud/volaticloud \
            --set deployments.volaticloud-backend.containers[0].imageTag=${{ steps.tag.outputs.tag }} \
            --set deployments.volaticloud-backend.imagePullSecrets[0].name=ghcr-pull-secret \
            --wait --timeout 10m --atomic

      - name: Verify
        run: |
          kubectl wait --for=condition=available --timeout=300s \
            deployment/volaticloud-backend-volaticloud-backend -n volaticloud
          sleep 30
          curl -f -s "https://api.volaticloud.com/health" || true

      - name: Summary
        run: |
          echo "### Backend Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://api.volaticloud.com" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback
    runs-on: ${{ vars.RUNNER_LABEL }}
    needs: deploy
    if: failure()
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl and Helm
        uses: ./.github/actions/setup-kubectl-helm
        with:
          kubeconfig: ${{ secrets.VKE_KUBECONFIG }}

      - name: Rollback
        run: |
          helm rollback volaticloud-backend -n volaticloud
          kubectl wait --for=condition=available --timeout=300s \
            deployment/volaticloud-backend-volaticloud-backend -n volaticloud

      - name: Summary
        run: |
          echo "### Rollback Completed" >> $GITHUB_STEP_SUMMARY
          helm history volaticloud-backend -n volaticloud