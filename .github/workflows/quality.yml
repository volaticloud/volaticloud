name: Code Quality

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  backend-coverage-report:
    name: Backend Coverage Report
    runs-on: ${{ vars.RUNNER_LABEL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Run tests
        run: go test -v -race -short -coverprofile=coverage.out -covermode=atomic ./...

      - name: Filter coverage
        id: coverage
        uses: ./.github/actions/coverage-filter

      - name: Generate report
        run: |
          echo "### Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "**Total: ${{ steps.coverage.outputs.coverage }}%**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.filtered.out | tail -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Comment PR
        uses: actions/github-script@v8
        with:
          script: |
            const { execSync } = require('child_process');
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const details = execSync('go tool cover -func=coverage.filtered.out | tail -20').toString();

            const comment = `## Backend Test Coverage Report

            **Total Coverage (excluding generated code): ${coverage}%**

            <details>
            <summary>View detailed coverage</summary>

            \`\`\`
            ${details}
            \`\`\`

            </details>

            Coverage report for commit ${context.sha.substring(0, 7)}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Coverage gate
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          THRESHOLD=85.0
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::warning::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
          fi

  frontend-coverage-report:
    name: Frontend Coverage Report
    runs-on: ${{ vars.RUNNER_LABEL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: ./.github/actions/setup-node
        with:
          node-version: '22'
          working-directory: 'dashboard'

      - name: Run tests with coverage
        working-directory: dashboard
        run: npm run test:coverage -- --run

      - name: Parse coverage
        id: coverage
        working-directory: dashboard
        run: |
          # Fail explicitly if coverage file is missing
          if [ ! -f coverage/coverage-summary.json ]; then
            echo "::error::Coverage file not found: coverage/coverage-summary.json"
            exit 1
          fi
          COVERAGE=$(cat coverage/coverage-summary.json | node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('/dev/stdin', 'utf8'));
            console.log(data.total.lines.pct.toFixed(2));
          ")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT

      - name: Generate report
        working-directory: dashboard
        run: |
          echo "### Frontend Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "**Total: ${{ steps.coverage.outputs.coverage }}%**" >> $GITHUB_STEP_SUMMARY

      - name: Comment PR
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const coverage = '${{ steps.coverage.outputs.coverage }}';

            const comment = `## Frontend Test Coverage Report

            **Total Coverage (excluding generated code): ${coverage}%**

            Coverage report for commit ${context.sha.substring(0, 7)}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Coverage gate
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          THRESHOLD=70.0
          if awk "BEGIN {exit !($COVERAGE < $THRESHOLD)}"; then
            echo "::warning::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
          fi

  go-report-card:
    name: Go Report Card
    runs-on: ${{ vars.RUNNER_LABEL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: gofmt
        run: |
          # Exclude cache and vendor directories (third-party code)
          FILES=$(find . -name '*.go' -not -path './.cache/*' -not -path './vendor/*' | xargs gofmt -l 2>/dev/null || true)
          if [ -n "$FILES" ]; then
            echo "Files need formatting:"
            echo "$FILES"
            exit 1
          fi

      - name: go vet
        run: go vet ./...

      - name: staticcheck
        uses: dominikh/staticcheck-action@v1
        with:
          version: "latest"
          # Let staticcheck install its own compatible Go version
          # until staticcheck supports Go 1.24.11+
          install-go: true
          min-go-version: "1.24"