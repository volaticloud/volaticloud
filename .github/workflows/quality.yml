name: Code Quality

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Filter coverage
        id: coverage
        uses: ./.github/actions/coverage-filter

      - name: Generate report
        run: |
          echo "### Test Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo "**Total: ${{ steps.coverage.outputs.coverage }}%**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.filtered.out | tail -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const details = execSync('go tool cover -func=coverage.filtered.out | tail -20').toString();

            const comment = `## Test Coverage Report

            **Total Coverage (excluding generated code): ${coverage}%**

            <details>
            <summary>View detailed coverage</summary>

            \`\`\`
            ${details}
            \`\`\`

            </details>

            Coverage report for commit ${context.sha.substring(0, 7)}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Coverage gate
        run: |
          COVERAGE=${{ steps.coverage.outputs.coverage }}
          THRESHOLD=85.0
          if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
            echo "::warning::Coverage ${COVERAGE}% is below threshold ${THRESHOLD}%"
          fi

  go-report-card:
    name: Go Report Card
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: ./.github/actions/setup-go

      - name: gofmt
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Files need formatting:"
            gofmt -l .
            exit 1
          fi

      - name: go vet
        run: go vet ./...

      - name: staticcheck
        uses: dominikh/staticcheck-action@v1
        with:
          version: "latest"
          install-go: false