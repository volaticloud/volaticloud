name: Deploy Ingress & TLS

on:
  push:
    branches: [main]  # Only deploy on merge to main
    paths:
      - 'deployments/ingress-nginx/**'
      - 'deployments/cert-manager/**'
      - 'deployments/keycloak/keycloak-ingress.yaml'
      - '.github/workflows/deploy-ingress.yaml'
  pull_request:  # Validation only, no deployment
    paths:
      - 'deployments/ingress-nginx/**'
      - 'deployments/cert-manager/**'
      - 'deployments/keycloak/keycloak-ingress.yaml'
      - '.github/workflows/deploy-ingress.yaml'
  workflow_dispatch:  # Allow manual deployment for emergencies
    inputs:
      skip-ingress:
        description: 'Skip nginx ingress installation (if already installed)'
        required: false
        type: boolean
        default: false
      skip-cert-manager:
        description: 'Skip cert-manager installation (if already installed)'
        required: false
        type: boolean
        default: false

jobs:
  validate:
    name: Validate Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate YAML syntax
        run: |
          echo "üîç Validating YAML syntax..."

          # Validate ingress-nginx values
          if [ -f "deployments/ingress-nginx/values.yaml" ]; then
            python3 -c "import yaml; yaml.safe_load(open('deployments/ingress-nginx/values.yaml'))" || {
              echo "‚ùå Invalid YAML: deployments/ingress-nginx/values.yaml"
              exit 1
            }
            echo "‚úÖ Valid: deployments/ingress-nginx/values.yaml"
          fi

          # Validate cert-manager manifests
          for file in values.yaml cluster-issuer.yaml; do
            if [ -f "deployments/cert-manager/$file" ]; then
              python3 -c "import yaml; list(yaml.safe_load_all(open('deployments/cert-manager/$file')))" || {
                echo "‚ùå Invalid YAML: deployments/cert-manager/$file"
                exit 1
              }
              echo "‚úÖ Valid: deployments/cert-manager/$file"
            fi
          done

          # Validate keycloak ingress
          if [ -f "deployments/keycloak/keycloak-ingress.yaml" ]; then
            python3 -c "import yaml; yaml.safe_load(open('deployments/keycloak/keycloak-ingress.yaml'))" || {
              echo "‚ùå Invalid YAML: deployments/keycloak/keycloak-ingress.yaml"
              exit 1
            }
            echo "‚úÖ Valid: deployments/keycloak/keycloak-ingress.yaml"
          fi

          echo "‚úÖ All manifests have valid YAML syntax"

  deploy-ingress:
    name: Deploy Nginx Ingress
    runs-on: ubuntu-latest
    needs: validate
    if: |
      always() &&
      needs.validate.result == 'success' &&
      ((github.event_name == 'push' && github.ref == 'refs/heads/main') ||
       (github.event_name == 'workflow_dispatch' && !inputs.skip-ingress))
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > ${{ github.workspace }}/kubeconfig
          export KUBECONFIG=${{ github.workspace }}/kubeconfig
          kubectl cluster-info
          echo "‚úÖ Connected to Kubernetes cluster"

      - name: Add nginx-ingress Helm repo
        run: |
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update

      - name: Install or upgrade nginx-ingress
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          echo "üì¶ Deploying nginx ingress controller..."
          helm upgrade --install nginx-ingress ingress-nginx/ingress-nginx \
            --namespace ingress-nginx \
            --create-namespace \
            --values deployments/ingress-nginx/values.yaml \
            --wait \
            --timeout 5m
          echo "‚úÖ Nginx ingress controller deployed"

      - name: Wait for Load Balancer
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          echo "‚è≥ Waiting for load balancer to be provisioned (may take 2-3 minutes)..."

          for i in {1..60}; do
            LB_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
              -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")

            if [ -n "$LB_IP" ]; then
              echo "‚úÖ Load balancer provisioned with IP: $LB_IP"
              echo "LOAD_BALANCER_IP=$LB_IP" >> $GITHUB_ENV
              break
            fi

            echo "Waiting for load balancer... ($i/60)"
            sleep 5
          done

          if [ -z "$LB_IP" ]; then
            echo "‚ö†Ô∏è  Load balancer not provisioned yet, but continuing..."
          fi

      - name: Verify nginx-ingress
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          echo "üìã Nginx Ingress Status:"
          echo ""
          echo "Pods:"
          kubectl get pods -n ingress-nginx
          echo ""
          echo "Service:"
          kubectl get svc -n ingress-nginx
          echo ""
          echo "IngressClass:"
          kubectl get ingressclass
          echo "‚úÖ Nginx ingress is ready"

  deploy-cert-manager:
    name: Deploy cert-manager
    runs-on: ubuntu-latest
    needs: [validate, deploy-ingress]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (needs.deploy-ingress.result == 'success' || needs.deploy-ingress.result == 'skipped') &&
      ((github.event_name == 'push' && github.ref == 'refs/heads/main') ||
       (github.event_name == 'workflow_dispatch' && !inputs.skip-cert-manager))
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > ${{ github.workspace }}/kubeconfig
          export KUBECONFIG=${{ github.workspace }}/kubeconfig
          kubectl cluster-info

      - name: Add cert-manager Helm repo
        run: |
          helm repo add jetstack https://charts.jetstack.io
          helm repo update

      - name: Install or upgrade cert-manager
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          echo "üì¶ Deploying cert-manager..."
          helm upgrade --install cert-manager jetstack/cert-manager \
            --namespace cert-manager \
            --create-namespace \
            --values deployments/cert-manager/values.yaml \
            --wait \
            --timeout 5m
          echo "‚úÖ cert-manager deployed"

      - name: Wait for cert-manager to be ready
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          echo "‚è≥ Waiting for cert-manager pods to be ready..."
          kubectl wait --for=condition=Ready pod \
            -l app.kubernetes.io/instance=cert-manager \
            -n cert-manager \
            --timeout=300s
          echo "‚úÖ cert-manager is ready"

      - name: Apply ClusterIssuer
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          echo "üì¶ Applying Let's Encrypt ClusterIssuer..."

          # Substitute email in ClusterIssuer
          export LETSENCRYPT_EMAIL="${{ secrets.LETSENCRYPT_EMAIL }}"
          envsubst < deployments/cert-manager/cluster-issuer.yaml > /tmp/cluster-issuer-processed.yaml

          cat /tmp/cluster-issuer-processed.yaml

          kubectl apply -f /tmp/cluster-issuer-processed.yaml

          echo "‚è≥ Waiting for ClusterIssuers to be ready..."
          sleep 10

          echo "‚úÖ ClusterIssuers configured"

      - name: Verify cert-manager
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          echo "üìã cert-manager Status:"
          echo ""
          echo "Pods:"
          kubectl get pods -n cert-manager
          echo ""
          echo "ClusterIssuers:"
          kubectl get clusterissuer
          echo "‚úÖ cert-manager is ready"

  update-keycloak-ingress:
    name: Update Keycloak Ingress with TLS
    runs-on: ubuntu-latest
    needs: [validate, deploy-ingress, deploy-cert-manager]
    if: |
      always() &&
      needs.validate.result == 'success' &&
      (needs.deploy-ingress.result == 'success' || needs.deploy-ingress.result == 'skipped') &&
      (needs.deploy-cert-manager.result == 'success' || needs.deploy-cert-manager.result == 'skipped') &&
      ((github.event_name == 'push' && github.ref == 'refs/heads/main') ||
       github.event_name == 'workflow_dispatch')
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.VKE_KUBECONFIG }}" | base64 -d > ${{ github.workspace }}/kubeconfig
          export KUBECONFIG=${{ github.workspace }}/kubeconfig
          kubectl cluster-info

      - name: Apply Keycloak Ingress with TLS
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          echo "üîß Updating Keycloak ingress with TLS..."

          # Substitute hostname
          export KEYCLOAK_HOSTNAME="${{ secrets.KEYCLOAK_HOSTNAME }}"
          envsubst < deployments/keycloak/keycloak-ingress.yaml > /tmp/keycloak-ingress-processed.yaml

          cat /tmp/keycloak-ingress-processed.yaml

          kubectl apply -f /tmp/keycloak-ingress-processed.yaml

          echo "‚úÖ Keycloak ingress updated with TLS"

      - name: Wait for certificate
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          echo "‚è≥ Waiting for TLS certificate to be issued..."
          echo "This may take 1-2 minutes for cert-manager to complete the HTTP-01 challenge"

          for i in {1..60}; do
            CERT_READY=$(kubectl get certificate keycloak-tls-cert -n keycloak \
              -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "False")

            if [ "$CERT_READY" = "True" ]; then
              echo "‚úÖ Certificate is ready!"
              break
            fi

            echo "Waiting for certificate... ($i/60)"
            sleep 5
          done

          if [ "$CERT_READY" != "True" ]; then
            echo "‚ö†Ô∏è  Certificate not ready yet. Check status with:"
            echo "  kubectl describe certificate keycloak-tls-cert -n keycloak"
            echo "  kubectl get challenges -n keycloak"
          fi

      - name: Get ingress status
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
        run: |
          echo "üìä Ingress Status:"
          echo ""
          echo "Ingress:"
          kubectl get ingress -n keycloak
          echo ""
          echo "Certificate:"
          kubectl get certificate -n keycloak
          echo ""

          # Get load balancer IP
          LB_IP=$(kubectl get svc -n ingress-nginx ingress-nginx-controller \
            -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")

          if [ -n "$LB_IP" ]; then
            echo "üåê Load Balancer IP: $LB_IP"
            echo "üìù Configure DNS:"
            echo "   Add A record: ${{ secrets.KEYCLOAK_HOSTNAME }} ‚Üí $LB_IP"
            echo ""
            echo "üîó Access Keycloak at: https://${{ secrets.KEYCLOAK_HOSTNAME }}/auth"
          fi

      - name: Deployment summary
        if: success()
        run: |
          echo "## ‚úÖ Ingress & TLS Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Deployment Components" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Nginx Ingress Controller" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ cert-manager" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Let's Encrypt ClusterIssuer (prod & staging)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Keycloak Ingress with TLS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîê Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Configure DNS A record pointing to load balancer IP" >> $GITHUB_STEP_SUMMARY
          echo "2. Wait 5-10 minutes for DNS propagation" >> $GITHUB_STEP_SUMMARY
          echo "3. cert-manager will automatically request and install TLS certificate" >> $GITHUB_STEP_SUMMARY
          echo "4. Access Keycloak at https://${{ secrets.KEYCLOAK_HOSTNAME }}/auth" >> $GITHUB_STEP_SUMMARY
