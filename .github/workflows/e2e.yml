name: E2E Tests

on:
  push:
    branches: [main]
    paths:
      - 'dashboard/**'
      - 'internal/**'
      - 'cmd/**'
      - 'docker-compose.e2e.yml'
      - 'Caddyfile.e2e'
      - 'Dockerfile'
      - '.github/workflows/e2e.yml'
  pull_request:
    branches: [main]
    paths:
      - 'dashboard/**'
      - 'internal/**'
      - 'cmd/**'
      - 'docker-compose.e2e.yml'
      - 'Caddyfile.e2e'
      - 'Dockerfile'
      - '.github/workflows/e2e.yml'
  workflow_dispatch:
    inputs:
      test-project:
        description: 'Playwright project to run'
        required: false
        default: 'strategy-scenarios'
        type: choice
        options:
          - strategy-scenarios
          - all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  COMPOSE_FILE: docker-compose.e2e.yml

jobs:
  e2e:
    name: E2E Tests
    runs-on: ${{ vars.RUNNER_LABEL }}
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Generate TLS certificates
        run: |
          mkdir -p certs
          # Generate CA key and certificate
          openssl genrsa -out certs/ca.key 4096
          openssl req -x509 -new -nodes -key certs/ca.key -sha256 -days 365 \
            -out certs/ca.crt -subj "/CN=VolatiCloud E2E CA"

          # Generate server key and CSR
          openssl genrsa -out certs/server.key 2048
          openssl req -new -key certs/server.key -out certs/server.csr \
            -subj "/CN=volaticloud.loc"

          # Create extension config for SAN
          cat > certs/ext.cnf << EOF
          authorityKeyIdentifier=keyid,issuer
          basicConstraints=CA:FALSE
          keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment
          subjectAltName = @alt_names

          [alt_names]
          DNS.1 = volaticloud.loc
          DNS.2 = *.volaticloud.loc
          DNS.3 = console.volaticloud.loc
          DNS.4 = auth.volaticloud.loc
          DNS.5 = localhost
          EOF

          # Sign server certificate
          openssl x509 -req -in certs/server.csr -CA certs/ca.crt -CAkey certs/ca.key \
            -CAcreateserial -out certs/server.crt -days 365 -sha256 -extfile certs/ext.cnf

      - name: Create .env file
        run: |
          cat > .env << EOF
          VOLATICLOUD_STRIPE_API_KEY=${{ secrets.STRIPE_API_KEY_TEST }}
          VOLATICLOUD_STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET_TEST }}
          EOF

      - name: Add hosts entries
        run: |
          echo "127.0.0.1 console.volaticloud.loc auth.volaticloud.loc" | sudo tee -a /etc/hosts

      - name: Start E2E environment
        run: |
          docker compose -f $COMPOSE_FILE up -d --build --wait
        timeout-minutes: 15

      - name: Wait for services to stabilize
        run: |
          echo "Waiting for services to stabilize..."
          sleep 10

          # Verify all services are healthy
          docker compose -f $COMPOSE_FILE ps

          # Check backend health
          docker compose -f $COMPOSE_FILE exec -T backend wget --no-verbose --tries=3 --spider http://localhost:8080/gateway/v1/health

          # Check dashboard health
          docker compose -f $COMPOSE_FILE exec -T dashboard wget --no-verbose --tries=3 --spider http://localhost:8080/

      - name: Run Playwright tests
        run: |
          TEST_PROJECT="${{ github.event.inputs.test-project || 'strategy-scenarios' }}"
          docker compose -f $COMPOSE_FILE --profile test run --rm \
            -e CI=true \
            playwright bash -c "npm ci && npx playwright test --project=$TEST_PROJECT"
        timeout-minutes: 20

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: dashboard/playwright-report/
          retention-days: 7

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: test-screenshots
          path: dashboard/test-results/
          retention-days: 7

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Backend logs ==="
          docker compose -f $COMPOSE_FILE logs backend --tail=100
          echo ""
          echo "=== Dashboard logs ==="
          docker compose -f $COMPOSE_FILE logs dashboard --tail=50
          echo ""
          echo "=== Keycloak logs ==="
          docker compose -f $COMPOSE_FILE logs keycloak --tail=50

      - name: Cleanup
        if: always()
        run: |
          docker compose -f $COMPOSE_FILE --profile test down -v --remove-orphans
