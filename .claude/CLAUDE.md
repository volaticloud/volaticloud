# AnyTrade Project Notes

## Project Structure

Project follows Go best practices with `internal` directory pattern:
- `internal/ent/` - ENT ORM schemas and generated code
- `internal/graph/` - GraphQL schemas and resolvers
- `cmd/server/` - Server entrypoint
- `internal/enum/` - Custom enum types with GraphQL marshalers

All imports use `anytrade/internal/ent` and `anytrade/internal/graph`.

## GraphQL Implementation

Successfully integrated ENT ORM with GraphQL using gqlgen.

### Key Configuration

1. **ENT GraphQL Extension** (`internal/ent/entc.go`):
   - Uses `entgql.NewExtension()` with schema generator
   - Generates schema to `../graph/ent.graphql`
   - Integrates with gqlgen via `../../gqlgen.yml`

2. **gqlgen Configuration** (`gqlgen.yml`):
   - Schema files: `internal/graph/schema.graphqls` (custom scalars) and `internal/graph/ent.graphql` (generated)
   - Time scalar mapped to `github.com/99designs/gqlgen/graphql.Time` (NOT `time.Time`)
   - Autobind all ENT packages for automatic type mapping
   - Node interface mapped to `anytrade/internal/ent.Noder`

3. **Build Process**:
   ```bash
   make generate  # Runs ENT generation + gqlgen generation
   make build     # Builds the binary
   ```

### GraphQL API Endpoints

Server runs on port 8080 by default:
- GraphQL Playground: `http://localhost:8080/`
- GraphQL API: `http://localhost:8080/query`
- Health Check: `http://localhost:8080/health`

### Available Queries

- `exchanges` - List all exchanges
- `bots` - List all trading bots
- `strategies` - List all strategies
- `backtests` - List all backtests
- `hyperOpts` - List all hyperopt runs
- `trades` - List all trades
- `exchangeSecrets` - List exchange API secrets
- `node(id: ID!)` - Fetch single node by ID
- `nodes(ids: [ID!]!)` - Fetch multiple nodes by IDs

All list queries support Relay-style pagination with `first`, `last`, `after`, `before` arguments.

### Available Mutations

All entities support full CRUD operations:

**Exchange:**
- `createExchange(input: CreateExchangeInput!)` - Create new exchange
- `updateExchange(id: ID!, input: UpdateExchangeInput!)` - Update exchange
- `deleteExchange(id: ID!)` - Delete exchange

**ExchangeSecret:**
- `createExchangeSecret(input: CreateExchangeSecretInput!)` - Create API secret
- `updateExchangeSecret(id: ID!, input: UpdateExchangeSecretInput!)` - Update secret
- `deleteExchangeSecret(id: ID!)` - Delete secret

**Strategy:**
- `createStrategy(input: CreateStrategyInput!)` - Create trading strategy
- `updateStrategy(id: ID!, input: UpdateStrategyInput!)` - Update strategy
- `deleteStrategy(id: ID!)` - Delete strategy

**Bot:**
- `createBot(input: CreateBotInput!)` - Create trading bot
- `updateBot(id: ID!, input: UpdateBotInput!)` - Update bot
- `deleteBot(id: ID!)` - Delete bot

**Backtest:**
- `createBacktest(input: CreateBacktestInput!)` - Create backtest task
- `updateBacktest(id: ID!, input: UpdateBacktestInput!)` - Update backtest
- `deleteBacktest(id: ID!)` - Delete backtest

**HyperOpt:**
- `createHyperOpt(input: CreateHyperOptInput!)` - Create hyperopt task
- `updateHyperOpt(id: ID!, input: UpdateHyperOptInput!)` - Update hyperopt
- `deleteHyperOpt(id: ID!)` - Delete hyperopt

**Trade:**
- `createTrade(input: CreateTradeInput!)` - Create trade record
- `updateTrade(id: ID!, input: UpdateTradeInput!)` - Update trade
- `deleteTrade(id: ID!)` - Delete trade

### Important Notes

- JSON fields in ENT schemas require `entgql.Skip(entgql.SkipAll)` annotation
- All ENT enum types need GraphQL marshaling methods (`MarshalGQL`/`UnmarshalGQL`)
- GraphQL resolvers are mostly auto-generated by ENT - minimal manual implementation needed
- Database defaults to SQLite at `./data/anytrade.db`

### Troubleshooting

If generation fails:
1. Ensure all JSON fields have `entgql.Skip()` annotations
2. Check that enum types implement GraphQL marshalers
3. Verify `graph/model/models.go` placeholder exists
4. Confirm Time scalar uses `github.com/99designs/gqlgen/graphql.Time`