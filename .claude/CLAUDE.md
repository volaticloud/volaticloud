# AnyTrade Project Notes

## Project Structure

Project follows Go best practices with `internal` directory pattern:
- `internal/ent/` - ENT ORM schemas and generated code
- `internal/graph/` - GraphQL schemas and resolvers
- `cmd/server/` - Server entrypoint
- `internal/enum/` - Custom enum types with GraphQL marshalers

All imports use `anytrade/internal/ent` and `anytrade/internal/graph`.

## GraphQL Implementation

Successfully integrated ENT ORM with GraphQL using gqlgen.

### Key Configuration

1. **ENT GraphQL Extension** (`internal/ent/entc.go`):
   - Uses `entgql.NewExtension()` with schema generator
   - Generates schema to `../graph/ent.graphql`
   - Integrates with gqlgen via `../../gqlgen.yml`

2. **gqlgen Configuration** (`gqlgen.yml`):
   - Schema files: `internal/graph/schema.graphqls` (custom scalars) and `internal/graph/ent.graphql` (generated)
   - Time scalar mapped to `github.com/99designs/gqlgen/graphql.Time` (NOT `time.Time`)
   - Autobind all ENT packages for automatic type mapping
   - Node interface mapped to `anytrade/internal/ent.Noder`

3. **Build Process**:
   ```bash
   make generate  # Runs ENT generation + gqlgen generation
   make build     # Builds the binary
   ```

### GraphQL API Endpoints

Server runs on port 8080 by default:
- GraphQL Playground: `http://localhost:8080/`
- GraphQL API: `http://localhost:8080/query`
- Health Check: `http://localhost:8080/health`

### Available Queries

- `exchanges` - List all exchanges
- `bots` - List all trading bots
- `strategies` - List all strategies
- `backtests` - List all backtests
- `trades` - List all trades
- `exchangeSecrets` - List exchange API secrets
- `node(id: ID!)` - Fetch single node by ID
- `nodes(ids: [ID!]!)` - Fetch multiple nodes by IDs

All list queries support Relay-style pagination with `first`, `last`, `after`, `before` arguments.

### Available Mutations

All entities support full CRUD operations:

**Exchange:**
- `createExchange(input: CreateExchangeInput!)` - Create new exchange
- `updateExchange(id: ID!, input: UpdateExchangeInput!)` - Update exchange
- `deleteExchange(id: ID!)` - Delete exchange

**ExchangeSecret:**
- `createExchangeSecret(input: CreateExchangeSecretInput!)` - Create API secret
- `updateExchangeSecret(id: ID!, input: UpdateExchangeSecretInput!)` - Update secret
- `deleteExchangeSecret(id: ID!)` - Delete secret

**Strategy:**
- `createStrategy(input: CreateStrategyInput!)` - Create trading strategy
- `updateStrategy(id: ID!, input: UpdateStrategyInput!)` - Update strategy
- `deleteStrategy(id: ID!)` - Delete strategy

**Bot:**
- `createBot(input: CreateBotInput!)` - Create trading bot
- `updateBot(id: ID!, input: UpdateBotInput!)` - Update bot
- `deleteBot(id: ID!)` - Delete bot

**Backtest:**
- `createBacktest(input: CreateBacktestInput!)` - Create backtest task
- `updateBacktest(id: ID!, input: UpdateBacktestInput!)` - Update backtest
- `deleteBacktest(id: ID!)` - Delete backtest

**Trade:**
- `createTrade(input: CreateTradeInput!)` - Create trade record
- `updateTrade(id: ID!, input: UpdateTradeInput!)` - Update trade
- `deleteTrade(id: ID!)` - Delete trade

### Important Notes

- JSON fields in ENT schemas require `entgql.Skip(entgql.SkipAll)` annotation
- All ENT enum types need GraphQL marshaling methods (`MarshalGQL`/`UnmarshalGQL`)
- GraphQL resolvers are mostly auto-generated by ENT - minimal manual implementation needed
- Database defaults to SQLite at `./data/anytrade.db`

## Testing

The project has comprehensive test coverage for GraphQL resolvers.

### Running Tests

```bash
make test         # Run all tests with coverage report
make coverage     # Run tests and open HTML coverage report in browser
```

### Test Structure

- `internal/graph/*_test.go` - GraphQL resolver tests for each entity
- `internal/graph/resolver_test.go` - Test infrastructure setup
- `internal/graph/test_helpers.go` - Helper functions for tests

### Test Coverage

**Real Test Coverage: 91.9%** (excluding all generated code and schema definitions)

Current GraphQL resolver coverage:
- Query resolvers: 100% (6/8 tested - Node/Nodes intentionally excluded)
- Mutation resolvers: 97% (17/18 at 100% - CreateBacktest uses ENT client directly)

Coverage reports are generated automatically:
- `coverage.out` - Raw coverage data (includes all code)
- `coverage.filtered.out` - Filtered coverage (excludes generated code)
- `coverage.html` - Interactive HTML report (based on filtered data)

The test command automatically filters out:
- All ENT-generated entity files
- All CRUD operation files (*_create.go, *_update.go, *_delete.go, *_query.go)
- GraphQL generated code (generated.go)
- ENT schema definitions (schema/*.go)
- Enum marshaling code
- Server main.go

This gives you accurate coverage metrics for your actual business logic and resolvers.

### Writing Tests

Use the test infrastructure in `resolver_test.go`:
```go
func TestMyEntity(t *testing.T) {
    resolver := setupTestResolver(t)
    mutationResolver := resolver.Mutation()
    queryResolver := resolver.Query()

    // Use ptr() helper for pointer fields
    // Use ctx() helper for context
}
```

### Troubleshooting

If generation fails:
1. Ensure all JSON fields have `entgql.Skip()` annotations
2. Check that enum types implement GraphQL marshalers
3. Verify `graph/model/models.go` placeholder exists
4. Confirm Time scalar uses `github.com/99designs/gqlgen/graphql.Time`